<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš€ REAL Trading Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        .header h1 {
            color: #10b981;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 10px;
        }
        .status-bar {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }
        .indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
        }
        .connected { background: #10b981; box-shadow: 0 0 15px #10b981; animation: pulse 2s infinite; }
        .disconnected { background: #ef4444; }
        .active { background: #f59e0b; animation: pulse 1.5s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin: 20px 0; }
        .card {
            background: #1e293b;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }
        .card h2 {
            color: #10b981;
            font-size: 1.5em;
            margin-bottom: 20px;
            border-bottom: 2px solid #10b981;
            padding-bottom: 10px;
        }
        input, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 16px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #10b981;
        }
        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        button:disabled {
            background: #475569;
            cursor: not-allowed;
        }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .btn-danger:hover { box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4); }
        .file-upload {
            border: 3px dashed #10b981;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            background: rgba(16, 185, 129, 0.05);
            transition: all 0.3s;
        }
        .file-upload:hover {
            background: rgba(16, 185, 129, 0.1);
            border-color: #059669;
        }
        .file-upload input { display: none; }
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 0.95em;
        }
        .alert-success { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid #10b981; }
        .alert-error { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .alert-info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; }
        .stat-box {
            background: linear-gradient(135deg, #1e293b, #334155);
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
            border: 1px solid #10b981;
        }
        .stat-box h3 {
            font-size: 2.5em;
            color: #10b981;
            margin: 10px 0;
        }
        .stat-box p {
            color: #94a3b8;
            font-size: 1em;
        }
        .trade-item {
            background: rgba(30, 41, 59, 0.5);
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border-right: 4px solid #10b981;
        }
        .executed-log {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 10px;
            padding: 10px;
            max-height: 420px;
            overflow-y: auto;
        }
        .executed-entry {
            border-bottom: 1px solid #1e293b;
            padding: 10px 5px;
        }
        .executed-entry:last-child {
            border-bottom: none;
        }
        .executed-entry strong {
            color: #10b981;
        }
        .executed-meta {
            color: #94a3b8;
            font-size: 0.85em;
        }
        .log {
            background: #0f172a;
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #334155;
        }
        .log p {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #1e293b;
            color: #10b981;
        }
        .full-width { grid-column: 1 / -1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ REAL Trading Platform</h1>
            <p style="text-align: center; color: #94a3b8; font-size: 1.2em;">
                Ù…Ù†ØµØ© ØªØ¯Ø§ÙˆÙ„ Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù…Ø¹ ProjectX API
            </p>
            <div class="status-bar">
                <div class="status-item">
                    <span class="indicator" id="connIndicator"></span>
                    <span>ProjectX: <strong id="connText">Disconnected</strong></span>
                </div>
                <div class="status-item">
                    <span class="indicator" id="modelIndicator"></span>
                    <span>ML Model: <strong id="modelText">Not Loaded</strong></span>
                </div>
                <div class="status-item">
                    <span class="indicator" id="tradeIndicator"></span>
                    <span>Trading: <strong id="tradeText">Stopped</strong></span>
                </div>
            </div>
        </div>

        <div class="grid">
            <!-- Connection -->
            <div class="card">
                <h2>ğŸ” Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ ProjectX API</h2>
                <select id="env">
                    <option value="TOPSTEP_X">TopStep</option>
                    <option value="E8X">E8X</option>
                    <option value="FUNDING_FUTURES">Funding Futures</option>
                    <option value="FXIFY_FUTURES">FXIFY Futures</option>
                    <option value="ALPHA_TICKS">Alpha Ticks</option>
                    <option value="BLUE_GUARDIAN">Blue Guardian</option>
                    <option value="BLUSKY">Blusky</option>
                    <option value="FUTURES_ELITE">Futures Elite</option>
                    <option value="GOAT_FUNDED">Goat Funded</option>
                    <option value="THE_FUTURES_DESK">The Futures Desk</option>
                    <option value="TICK_TICK_TRADER">Tick Tick Trader</option>
                    <option value="TOP_ONE_FUTURES">Top One Futures</option>
                    <option value="TX3_FUNDING">TX3 Funding</option>
                </select>
                <input type="text" id="username" placeholder="Username">
                <input type="password" id="apiKey" placeholder="API Key">
                <button onclick="connect()" id="connectBtn">ğŸ”— Ø§ØªØµØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
                <button onclick="disconnect()" id="disconnectBtn" class="btn-danger" style="display:none;">â›” Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„</button>
                <div id="connAlert"></div>
                
                <!-- Account Selection -->
                <div id="accountSelection" style="display:none; margin-top:15px;">
                    <label style="display:block; margin:10px 0; font-weight:bold; color:#10b981;">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨:</label>
                    <select id="accountSelect" style="width:100%; padding:12px; margin:5px 0;">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ --</option>
                    </select>
                    <button onclick="selectAccount()" style="width:100%; margin-top:10px;">âœ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                </div>
            </div>

            <!-- Model Upload -->
            <div class="card">
                <h2>ğŸ¤– Ø±ÙØ¹ ML Model</h2>
                <div class="file-upload" onclick="document.getElementById('modelFile').click()">
                    <input type="file" id="modelFile" accept=".pkl" onchange="uploadModel()">
                    <div style="font-size: 3em; margin-bottom: 10px;">ğŸ“¤</div>
                    <p style="font-size: 1.1em; font-weight: 600; color: #10b981;">Ø§Ø³Ø­Ø¨ Ù…Ù„Ù .pkl Ù‡Ù†Ø§</p>
                </div>
                <div id="modelAlert"></div>
            </div>

            <!-- Contract Selection -->
            <div class="card" id="contractCard" style="display:none;">
                <h2>ğŸ“Š Ø§Ø®ØªÙŠØ§Ø± Contract</h2>
                <select id="contractSelect" style="width:100%; padding:12px; margin:5px 0;">
                    <option value="CON.F.US.EP.U25">ES (E-mini S&P 500)</option>
                    <option value="CON.F.US.ENQ.U25">NQ (E-mini NASDAQ-100)</option>
                    <option value="CON.F.US.RTY.U25">RTY (E-mini Russell 2000)</option>
                </select>
                <button onclick="selectContract()" style="width:100%; margin-top:10px;">âœ… Ø§Ø®ØªÙŠØ§Ø±</button>
                <div id="contractAlert"></div>
            </div>

            <!-- Trading Control -->
            <div class="card">
                <h2>âš¡ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ØªØ¯Ø§ÙˆÙ„</h2>
                <div class="alert alert-info">
                    <strong>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª:</strong><br>
                    Max Trades: 3/day<br>
                    Max Loss: $1,000<br>
                    Min Prob: 70%
                </div>
                <button onclick="startTrading()" id="startBtn" disabled>â–¶ï¸ Ø¨Ø¯Ø¡ ØªØ¯Ø§ÙˆÙ„ Ø­Ù‚ÙŠÙ‚ÙŠ</button>
                <button onclick="stopTrading()" id="stopBtn" class="btn-danger" style="display:none;">â¸ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
            </div>

            <!-- ML Settings -->
            <div class="card" id="settingsCard">
                <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</h2>
                <div class="alert alert-info" style="font-size:0.9em;">
                    <strong>âš¡ ML Thresholds:</strong> Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ØµÙÙ‚Ø©ØŒ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©ØŒ Ø§Ù„Ø®Ø³Ø§Ø±Ø© Ø§Ù„Ù‚ØµÙˆÙ‰<br>
                    <strong>ğŸ” Setup Detection:</strong> Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø§ÙƒØªØ´Ø§Ù (Ø£Ù‚Ù„ = Ø£ÙƒØ«Ø± Ø­Ø³Ø§Ø³ÙŠØ©)ØŒ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø´Ù…ÙˆØ¹ØŒ momentum
                </div>
                <label>ğŸ”¢ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø§Ø­ØªÙ…Ø§Ù„ Ø§Ù„ØµÙÙ‚Ø© (%)</label>
                <input type="number" id="minProbInput" min="40" max="99" step="1" value="70">
                <label>ğŸ“ˆ Ø£Ù‚ØµÙ‰ Ø¹Ø¯Ø¯ ØµÙÙ‚Ø§Øª ÙÙŠ Ø§Ù„ÙŠÙˆÙ…</label>
                <input type="number" id="maxTradesInput" min="1" max="10" step="1" value="3">
                <label>ğŸ’¸ Ø£Ù‚ØµÙ‰ Ø®Ø³Ø§Ø±Ø© ÙŠÙˆÙ…ÙŠØ© (USD)</label>
                <input type="number" id="maxLossInput" min="50" step="50" value="1000">
                <label>ğŸ“Š Ø­Ø³Ø§Ø³ÙŠØ© Ø§ÙƒØªØ´Ø§Ù Setups (Ã—StdDev) - Ø£Ù‚Ù„ = Ø£ÙƒØ«Ø± Ø­Ø³Ø§Ø³ÙŠØ©</label>
                <input type="number" id="thresholdMultInput" min="0.5" max="3.0" step="0.1" value="1.5">
                <label>ğŸ•¯ï¸ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù„Ø´Ù…ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                <input type="number" id="minCandlesInput" min="10" max="50" step="1" value="20">
                <label>âš¡ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ù€ Momentum (Ticks)</label>
                <input type="number" id="minMomentumInput" min="2" max="20" step="1" value="6">
                <label style="display:flex; align-items:center; margin-top:15px;">
                    <input type="checkbox" id="debugSetupInput" style="width:auto; margin-left:10px;">
                    ğŸ” ØªÙØ¹ÙŠÙ„ Debug Mode (Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§ÙƒØªØ´Ø§Ù Setups ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª)
                </label>
                <button onclick="saveSettings()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <div id="settingsAlert"></div>
            </div>

            <!-- Account Info -->
            <div class="card full-width">
                <h2>ğŸ’° Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-box">
                        <p>Ø§Ù„Ø±ØµÙŠØ¯</p>
                        <h3 id="balance">$0.00</h3>
                    </div>
                    <div class="stat-box">
                        <p>P&L Ø§Ù„ÙŠÙˆÙ…ÙŠ</p>
                        <h3 id="dailyPnL">$0.00</h3>
                    </div>
                    <div class="stat-box">
                        <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙ‚Ø§Øª</p>
                        <h3 id="totalTrades">0</h3>
                    </div>
                    <div class="stat-box">
                        <p>Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</p>
                        <h3 id="winRate">0%</h3>
                    </div>
                </div>
            </div>

            <!-- Orders -->
            <div class="card">
                <h2>ğŸ“ˆ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø©</h2>
                <div id="orders" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #475569; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø±</p>
                </div>
                <button onclick="updateOrders()" style="margin-top:10px; width:100%;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>

            <!-- Positions -->
            <div class="card">
                <h2>ğŸ’¼ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©</h2>
                <div id="positions" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: #475569; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª</p>
                </div>
                <button onclick="updatePositions()" style="margin-top:10px; width:100%;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            </div>

            <!-- Quick Trade -->
            <div class="card" id="quickTradeCard" style="display:none;">
                <h2>âš¡ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©</h2>
                <div class="alert alert-info" style="margin-bottom:15px; font-size:0.9em;">
                    <strong>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong><br>
                    1. Ø£Ø¯Ø®Ù„ Entry, Stop Loss, Take Profit<br>
                    2. Ø§Ø®ØªØ± BUY Ø£Ùˆ SELL<br>
                    3. Ø§Ø¶ØºØ· "ğŸš€ ØªÙ†ÙÙŠØ° Ù…Ø¹ ML" Ù„ØªÙ‚ÙŠÙŠÙ… Setup<br>
                    4. Ø£Ùˆ "âš¡ ØªÙ†ÙÙŠØ° Ù…Ø¨Ø§Ø´Ø±" Ù„ØªÙ†ÙÙŠØ° Ø¨Ø¯ÙˆÙ† ML
                </div>
                <select id="tradeType" style="margin:5px 0;">
                    <option value="BUY">ğŸŸ¢ BUY (Ø´Ø±Ø§Ø¡)</option>
                    <option value="SELL">ğŸ”´ SELL (Ø¨ÙŠØ¹)</option>
                </select>
                <input type="number" id="tradeEntry" placeholder="Entry Price (Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„)" step="0.25">
                <input type="number" id="tradeSL" placeholder="Stop Loss (ÙˆÙ‚Ù Ø§Ù„Ø®Ø³Ø§Ø±Ø©)" step="0.25">
                <input type="number" id="tradeTP" placeholder="Take Profit (Ø¬Ù†ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­)" step="0.25">
                <input type="number" id="tradeStrength" placeholder="Strength (1-20)" value="10" step="0.5" min="1" max="20">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                    <button onclick="executeTrade()" style="width:100%; background:linear-gradient(135deg, #10b981, #059669);">
                        ğŸ¤– ØªÙ†ÙÙŠØ° Ù…Ø¹ ML
                    </button>
                    <button onclick="executeTradeDirect()" style="width:100%; background:linear-gradient(135deg, #3b82f6, #2563eb);">
                        âš¡ ØªÙ†ÙÙŠØ° Ù…Ø¨Ø§Ø´Ø±
                    </button>
                </div>
                <div id="tradeAlert" style="margin-top:15px;"></div>
            </div>

            <!-- Executed Trades -->
            <div class="card full-width" id="executedTradesCard" style="display:none;">
                <h2>ğŸ¯ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„Ù…Ù†ÙØ°Ø© (ML)</h2>
                <div class="executed-log" id="executedTrades">
                    <p style="text-align:center; color:#475569; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ø¨Ø¹Ø¯</p>
                </div>
                <button onclick="refreshExecutedTrades()" style="margin-top:10px; width:100%;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙÙ‚Ø§Øª</button>
            </div>

            <!-- Skipped Trades -->
            <div class="card full-width" id="skippedTradesCard" style="display:none;">
                <h2>â­ï¸ Ø§Ù„ØµÙÙ‚Ø§Øª Ø§Ù„ØªÙŠ ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</h2>
                <div class="executed-log" id="skippedTrades">
                    <p style="text-align:center; color:#475569; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ØªØ¬Ø§Ù‡Ù„Ø© Ø¨Ø¹Ø¯</p>
                </div>
                <button onclick="refreshSkippedTrades()" style="margin-top:10px; width:100%;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØ¬Ø§Ù‡Ù„Ø©</button>
            </div>

            <!-- Today's Signals CSV -->
            <div class="card full-width">
                <h2>ğŸ“Š Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… (CSV)</h2>
                <div id="csvInfo" style="padding:15px; background:#0f172a; border-radius:10px; margin-bottom:15px;">
                    <p style="text-align:center; color:#64748b;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù...</p>
                </div>
                <button onclick="downloadTodayCSV()" style="width:100%; background:linear-gradient(135deg, #3b82f6, #2563eb);">
                    ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù CSV Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…
                </button>
                <div id="csvAlert" style="margin-top:10px;"></div>
            </div>

            <!-- API Status -->
            <div class="card full-width" id="apiStatusCard" style="display:none;">
                <h2>ğŸ”Œ Ø­Ø§Ù„Ø© ProjectX API</h2>
                <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-box">
                        <p>Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±</p>
                        <h3 id="selectedAccount">-</h3>
                    </div>
                    <div class="stat-box">
                        <p>Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±</p>
                        <h3 id="selectedContract">CON.F.US.EP.U25</h3>
                    </div>
                    <div class="stat-box">
                        <p>Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ù…ÙØªÙˆØ­Ø©</p>
                        <h3 id="openPositionsCount">0</h3>
                    </div>
                    <div class="stat-box">
                        <p>Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù†Ø´Ø·Ø©</p>
                        <h3 id="openOrdersCount">0</h3>
                    </div>
                </div>
            </div>

            <!-- Live Chart -->
            <div class="card full-width" id="chartCard" style="display:none !important;">
                <h2>ğŸ“Š Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø§Ù„Ø­ÙŠ 
                    <span class="live-indicator" id="liveIndicator" style="display:inline-block; width:12px; height:12px; background:#10b981; border-radius:50%; margin-left:10px; animation: pulse 2s infinite;"></span>
                    <span style="color:#10b981; font-size:0.8em; font-weight:normal;">LIVE</span>
                </h2>
                <div style="background:#0f172a; padding:15px; border-radius:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div>
                            <span style="color:#10b981; font-size:1.5em; font-weight:bold;" id="currentPrice">--</span>
                            <span id="priceChange" style="margin-left:10px; font-size:0.9em;"></span>
                            <br>
                            <span style="color:#64748b; font-size:0.9em;" id="contractName">--</span>
                            <span style="color:#64748b; font-size:0.8em; margin-left:10px;" id="lastUpdate">--</span>
                        </div>
                        <div>
                            <label style="color:#94a3b8; font-size:0.9em; margin-right:10px;">
                                <input type="checkbox" id="useLiveData" checked onchange="/* updateChart() disabled */"> Ø¨ÙŠØ§Ù†Ø§Øª Ø­ÙŠØ©
                            </label>
                            <select id="chartTimeframe" onchange="/* updateChart() disabled */" style="padding:8px; background:#1e293b; border:1px solid #334155; color:#e2e8f0; border-radius:5px;">
                                <option value="1">1m</option>
                                <option value="5" selected>5m</option>
                                <option value="15">15m</option>
                                <option value="30">30m</option>
                                <option value="60">1h</option>
                            </select>
                            <button onclick="/* updateChart() disabled */" style="padding:8px 15px; margin-left:10px; width:auto;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                        </div>
                    </div>
                    <div id="tradingview_chart" style="height:400px; width:100%;"></div>
                </div>
            </div>

            <!-- System Log -->
            <div class="card full-width">
                <h2>ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… (REAL API Calls)</h2>
                <div class="log" id="log">
                    <p>[SYSTEM] REAL Trading Platform initialized</p>
                    <p>[INFO] Connect to ProjectX API with real credentials</p>
                    <p>[INFO] Upload ML model to start trading</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- TradingView Widget -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <!-- Socket.IO client from CDN with fallback -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
    <script>
        (function ensureSocketIoClient() {
            if (typeof io === 'function') {
                console.log('âœ… Socket.IO client loaded from primary CDN');
                window.__socketIoReady = true;
                return;
            }
            
            const fallbackSources = [
                'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js',
                'https://unpkg.com/socket.io-client@4.7.5/dist/socket.io.min.js'
            ];
            let current = 0;
            
            function tryLoadFallback() {
                if (current >= fallbackSources.length) {
                    console.error('âŒ Unable to load Socket.IO client from available CDNs');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = fallbackSources[current];
                script.crossOrigin = 'anonymous';
                script.onload = () => {
                    console.log(`[WS] âœ… Socket.IO client loaded from fallback: ${fallbackSources[current]}`);
                    window.__socketIoReady = true;
                };
                script.onerror = () => {
                    console.warn(`[WS] âš ï¸ Failed to load Socket.IO from: ${fallbackSources[current]}`);
                    current += 1;
                    tryLoadFallback();
                };
                document.head.appendChild(script);
            }
            
            tryLoadFallback();
        })();
    </script>

    <!-- TradingView Lightweight Charts (Ù…ÙƒØªØ¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø© - Ù„ÙŠØ³Øª Widget) -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
    
    <script>
        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØ­Ù…ÙŠÙ„ Lightweight Charts
        function waitForLightweightCharts(callback, maxAttempts = 50) {
            let attempts = 0;
            const checkInterval = setInterval(() => {
                attempts++;
                if (typeof LightweightCharts !== 'undefined' && typeof LightweightCharts.createChart === 'function') {
                    clearInterval(checkInterval);
                    console.log('âœ… TradingView Lightweight Charts loaded successfully');
                    callback();
                } else if (attempts >= maxAttempts) {
                    clearInterval(checkInterval);
                    console.error('âŒ Lightweight Charts failed to load after', maxAttempts, 'attempts');
                    document.addEventListener('DOMContentLoaded', function() {
                        const chartContainer = document.getElementById('tradingview_chart');
                        if (chartContainer) {
                            chartContainer.innerHTML = '<div style="padding:50px; text-align:center; color:#ef4444;">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© TradingView Widget<br><small>Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</small></div>';
                        }
                    });
                }
            }, 100);
        }
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©
        waitForLightweightCharts(function() {
            console.log('Lightweight Charts ready');
        });
        
        let updateInterval = null;
        let lightweightChart = null;
        let candlestickSeries = null;
        let orderBlockPriceLines = [];
        let fvgPriceLines = [];
        let tradeMarkers = [];
        let chartUpdateInterval = null;
        let selectedContract = 'CON.F.US.EP.U25'; // Default contract
        let currentOrderBlocks = [];
        let currentFVGs = [];
        let currentTrades = [];
        let socket = null;
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ©
        function generateDemoData(basePrice = 6580, barsCount = 100) {
            const data = [];
            let currentPrice = basePrice;
            const now = Math.floor(Date.now() / 1000);
            
            for (let i = barsCount - 1; i >= 0; i--) {
                const change = (Math.random() - 0.5) * 10; // ØªØºÙŠÙŠØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Â±5 Ù†Ù‚Ø§Ø·
                const open = currentPrice;
                const close = open + change;
                const high = Math.max(open, close) + Math.random() * 3;
                const low = Math.min(open, close) - Math.random() * 3;
                
                data.push({
                    time: now - (i * 300), // ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚
                    open: parseFloat(open.toFixed(2)),
                    high: parseFloat(high.toFixed(2)),
                    low: parseFloat(low.toFixed(2)),
                    close: parseFloat(close.toFixed(2)),
                });
                
                currentPrice = close;
            }
            
            return data;
        }

        function addLog(msg) {
            const log = document.getElementById('log');
            const time = new Date().toLocaleTimeString('ar-SA');
            log.innerHTML += `<p>[${time}] ${msg}</p>`;
            log.scrollTop = log.scrollHeight;
        }

        let lastPrice = null;
        
        function renderStatus(data) {
            if (!data) {
                console.warn('[STATUS] renderStatus called with no data');
                return;
            }
            
            console.log('[STATUS] Updating status bar:', data);
            
            // ØªØ­Ø¯ÙŠØ« Connection indicator
            const connIndicator = document.getElementById('connIndicator');
            const connText = document.getElementById('connText');
            
            if (connIndicator && connText) {
                const isConnected = data.is_connected === true || data.is_connected === 'true';
                connIndicator.className = 'indicator ' + (isConnected ? 'connected' : 'disconnected');
                connText.textContent = isConnected ? 'Connected' : 'Disconnected';
                console.log('[STATUS] Connection updated:', isConnected ? 'Connected' : 'Disconnected');
            } else {
                console.warn('[STATUS] Connection elements not found');
            }
            
            // ØªØ­Ø¯ÙŠØ« ML Model indicator
            const modelIndicator = document.getElementById('modelIndicator');
            const modelText = document.getElementById('modelText');
            
            if (modelIndicator && modelText) {
                const isModelLoaded = data.model_loaded === true || data.model_loaded === 'true';
                modelIndicator.className = 'indicator ' + (isModelLoaded ? 'connected' : 'disconnected');
                
                // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø­Ù…Ù„Ø§Ù‹ØŒ Ø£Ùˆ "Not Loaded" Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ†
                if (isModelLoaded && data.model_name) {
                    modelText.textContent = data.model_name.length > 20 ? data.model_name.substring(0, 20) + '...' : data.model_name;
                } else {
                    modelText.textContent = 'Not Loaded';
                }
                console.log('[STATUS] Model updated:', isModelLoaded ? (data.model_name || 'Loaded') : 'Not Loaded');
            } else {
                console.warn('[STATUS] Model elements not found');
            }
            
            // ØªØ­Ø¯ÙŠØ« Trading indicator
            const tradeIndicator = document.getElementById('tradeIndicator');
            const tradeText = document.getElementById('tradeText');
            
            if (tradeIndicator && tradeText) {
                const isTrading = data.is_trading === true || data.is_trading === 'true';
                tradeIndicator.className = 'indicator ' + (isTrading ? 'active' : 'disconnected');
                tradeText.textContent = isTrading ? 'Active' : 'Stopped';
                console.log('[STATUS] Trading updated:', isTrading ? 'Active' : 'Stopped');
            } else {
                console.warn('[STATUS] Trading elements not found');
            }
        }
        
        function renderAccountInfo(data) {
            if (!data) return;
            const balanceElement = document.getElementById('balance');
            if (balanceElement && typeof data.balance === 'number') {
                balanceElement.textContent = `$${data.balance.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
            }
            const dailyPnL = document.getElementById('dailyPnL');
            if (dailyPnL && typeof data.daily_pnl === 'number') {
                dailyPnL.textContent = `$${data.daily_pnl.toFixed(2)}`;
            }
        }
        
        function renderStatsUI(data) {
            if (!data) return;
            if (typeof data.total_trades === 'number') {
                document.getElementById('totalTrades').textContent = data.total_trades;
            }
            if (typeof data.win_rate === 'number') {
                document.getElementById('winRate').textContent = `${data.win_rate.toFixed(1)}%`;
            }
        }
        
        function renderPositions(positions = []) {
            const positionsDiv = document.getElementById('positions');
            if (!positionsDiv) return;
            if (positions.length === 0) {
                positionsDiv.innerHTML = '<p style="text-align: center; color: #475569; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª</p>';
                const countEl = document.getElementById('openPositionsCount');
                if (countEl) countEl.textContent = '0';
                return;
            }
            let html = '';
            positions.forEach(pos => {
                const type = pos.type === 1 ? 'ğŸŸ¢ LONG' : 'ğŸ”´ SHORT';
                const size = pos.size ?? pos.quantity ?? 0;
                const avg = pos.averagePrice ?? pos.avgPrice ?? 0;
                html += `
                    <div style="background:#1e293b; padding:12px; margin:5px 0; border-radius:8px;">
                        <strong>${type}</strong> ${pos.contractId || selectedContract}<br>
                        Size: ${size} | Avg: $${Number(avg).toFixed(2)}<br>
                        <button onclick="closePosition('${pos.contractId}')" style="margin-top:5px; font-size:0.85em;">âŒ Ø¥ØºÙ„Ø§Ù‚</button>
                    </div>
                `;
            });
            positionsDiv.innerHTML = html;
            const countEl = document.getElementById('openPositionsCount');
            if (countEl) countEl.textContent = positions.length;
        }
        
        function renderOrders(orders = []) {
            const ordersDiv = document.getElementById('orders');
            if (!ordersDiv) return;
            if (orders.length === 0) {
                ordersDiv.innerHTML = '<p style="text-align: center; color: #475569; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙˆØ§Ù…Ø±</p>';
                const countEl = document.getElementById('openOrdersCount');
                if (countEl) countEl.textContent = '0';
                return;
            }
            let html = '';
            orders.forEach(order => {
                const side = order.side === 0 ? 'ğŸŸ¢ BUY' : 'ğŸ”´ SELL';
                const status = order.status === 1 ? 'Open' : order.status === 2 ? 'Filled' : 'Other';
                const limit = order.limitPrice ? `Limit: $${Number(order.limitPrice).toFixed(2)}` : '';
                const stop = order.stopPrice ? `Stop: $${Number(order.stopPrice).toFixed(2)}` : '';
                html += `
                    <div style="background:#1e293b; padding:12px; margin:5px 0; border-radius:8px;">
                        <strong>${side}</strong> ${order.contractId || selectedContract}<br>
                        Size: ${order.size} | Status: ${status}<br>
                        ${limit} ${stop}<br>
                        <button onclick="cancelOrder(${order.id || order.orderId || 0})" style="margin-top:5px; font-size:0.85em;">âŒ Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                `;
            });
            ordersDiv.innerHTML = html;
            const countEl = document.getElementById('openOrdersCount');
            if (countEl) countEl.textContent = orders.length;
        }
        
        let obSeries = null;  // Order Blocks series
        // Note: tradeMarkers already declared above at line 563
        
        function applyChartData(data, fallbackContract, fallbackSource) {
            if (!data) return;
            const contract = data.contract || fallbackContract || selectedContract || 'CON.F.US.EP.U25';
            const dataSource = data.data_source || fallbackSource || 'SIM';
            // Order Blocks ÙˆØ§Ù„ØµÙÙ‚Ø§Øª Ù…Ù† API - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
            const orderBlocksData = data.order_blocks || [];
            const executedTradesData = data.executed_trades || [];
            const fvgsData = data.fvgs || [];
            
            console.log(`[CHART] ğŸ” applyChartData - Full data keys:`, Object.keys(data));
            console.log(`[CHART] ğŸ” applyChartData - order_blocks:`, data.order_blocks, `(type: ${typeof data.order_blocks})`);
            console.log(`[CHART] ğŸ” applyChartData - orderBlocksData:`, orderBlocksData, `(length: ${orderBlocksData.length})`);
            console.log(`[CHART] ğŸ” applyChartData - fvgs:`, data.fvgs, `(type: ${typeof data.fvgs})`);
            console.log(`[CHART] ğŸ” applyChartData - fvgsData:`, fvgsData, `(length: ${fvgsData.length})`);
            console.log(`[CHART] ğŸ” applyChartData - executed_trades:`, data.executed_trades, `(type: ${typeof data.executed_trades})`);
            
            let candlestickData = data.candles;
            if (!candlestickData && data.labels && data.data) {
                candlestickData = [];
                for (let i = 0; i < data.labels.length; i++) {
                    try {
                        const timestamp = new Date(data.labels[i]).getTime() / 1000;
                        if (isNaN(timestamp)) continue;
                        candlestickData.push({
                            time: timestamp,
                            open: parseFloat(data.data.open[i]),
                            high: parseFloat(data.data.high[i]),
                            low: parseFloat(data.data.low[i]),
                            close: parseFloat(data.data.close[i]),
                        });
                    } catch (error) {
                        console.warn('[CHART] Invalid data point', error);
                    }
                }
            }
            if (Array.isArray(candlestickData)) {
                candlestickData = candlestickData.filter(c =>
                    c &&
                    Number.isFinite(c.time) &&
                    Number.isFinite(c.open) &&
                    Number.isFinite(c.high) &&
                    Number.isFinite(c.low) &&
                    Number.isFinite(c.close)
                );
            }
            if (!candlestickData || candlestickData.length === 0) {
                console.warn('[CHART] No valid candlestick data');
                return;
            }
            selectedContract = contract;
            
            console.log(`[CHART] âœ… Applying chart data: ${candlestickData.length} candles, ${orderBlocksData.length} OBs, ${fvgsData.length} FVGs`);
            
            // Ø±Ø³Ù… Order Blocks Ùˆ FVGs ÙˆØ§Ù„ØµÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            displayTradingViewChart(candlestickData, contract, dataSource, orderBlocksData, executedTradesData, fvgsData);
            const latestCandle = candlestickData[candlestickData.length - 1];
            const currentPrice = (typeof data.current_price === 'number') ? data.current_price : latestCandle.close;
            const priceElement = document.getElementById('currentPrice');
            if (priceElement) {
                priceElement.style.transition = 'color 0.3s';
                priceElement.textContent = `$${currentPrice.toFixed(2)}`;
                priceElement.style.color = '#f59e0b';
                setTimeout(() => { priceElement.style.color = '#10b981'; }, 300);
            }
            const priceChange = document.getElementById('priceChange');
            if (priceChange) {
                let priceChangeHtml = '';
                if (lastPrice !== null) {
                    const change = currentPrice - lastPrice;
                    const changePercent = lastPrice === 0 ? 0 : ((change / lastPrice) * 100).toFixed(2);
                    const arrow = change > 0 ? 'â–²' : change < 0 ? 'â–¼' : 'â”€';
                    const color = change > 0 ? '#10b981' : change < 0 ? '#ef4444' : '#64748b';
                    priceChangeHtml = `<span style="color:${color};">${arrow} ${Math.abs(change).toFixed(2)} (${changePercent}%)</span>`;
                }
                priceChange.innerHTML = priceChangeHtml;
            }
            lastPrice = currentPrice;
            const contractElement = document.getElementById('contractName');
            if (contractElement) contractElement.textContent = contract;
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = `ØªØ­Ø¯ÙŠØ«: ${now.toLocaleTimeString('ar-SA')} (${dataSource})`;
            }
            const liveIndicator = document.getElementById('liveIndicator');
            if (liveIndicator) {
                liveIndicator.style.background = dataSource === 'LIVE' ? '#10b981' : '#f59e0b';
            }
        }
        
        /* Original applyChartData code - disabled (now replaced above)
        function applyChartData_ORIGINAL(data, fallbackContract, fallbackSource) {
            if (!data) return;
            const contract = data.contract || fallbackContract || selectedContract || 'CON.F.US.EP.U25';
            const dataSource = data.data_source || fallbackSource || 'SIM';
            // Order Blocks ÙˆØ§Ù„ØµÙÙ‚Ø§Øª Ù…Ù† API - Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹
            const orderBlocksData = data.order_blocks || [];
            const executedTradesData = data.executed_trades || [];
            const fvgsData = data.fvgs || [];
            
            // Logging Ù„Ù„ØªØ­Ù‚Ù‚
            console.log(`[CHART] ğŸ” applyChartData - Full data keys:`, Object.keys(data));
            console.log(`[CHART] ğŸ” applyChartData - order_blocks:`, data.order_blocks, `(type: ${typeof data.order_blocks})`);
            console.log(`[CHART] ğŸ” applyChartData - orderBlocksData:`, orderBlocksData, `(length: ${orderBlocksData.length})`);
            console.log(`[CHART] ğŸ” applyChartData - fvgs:`, data.fvgs, `(type: ${typeof data.fvgs})`);
            console.log(`[CHART] ğŸ” applyChartData - fvgsData:`, fvgsData, `(length: ${fvgsData.length})`);
            console.log(`[CHART] ğŸ” applyChartData - executed_trades:`, data.executed_trades, `(type: ${typeof data.executed_trades})`);
            
            // Log full data object Ù„Ù„ØªØ­Ù‚Ù‚
            console.log(`[CHART] ğŸ” Full data object:`, JSON.stringify(data).substring(0, 500));
            
            let candlestickData = data.candles;
            if (!candlestickData && data.labels && data.data) {
                candlestickData = [];
                for (let i = 0; i < data.labels.length; i++) {
                    try {
                        const timestamp = new Date(data.labels[i]).getTime() / 1000;
                        if (isNaN(timestamp)) continue;
                        candlestickData.push({
                            time: timestamp,
                            open: parseFloat(data.data.open[i]),
                            high: parseFloat(data.data.high[i]),
                            low: parseFloat(data.data.low[i]),
                            close: parseFloat(data.data.close[i]),
                        });
                    } catch (error) {
                        console.warn('[CHART] Invalid data point', error);
                    }
                }
            }
            if (Array.isArray(candlestickData)) {
                candlestickData = candlestickData.filter(c =>
                    c &&
                    Number.isFinite(c.time) &&
                    Number.isFinite(c.open) &&
                    Number.isFinite(c.high) &&
                    Number.isFinite(c.low) &&
                    Number.isFinite(c.close)
                );
            }
            if (!candlestickData || candlestickData.length === 0) return;
            selectedContract = contract;
            
            // Ø±Ø³Ù… Order Blocks Ùˆ FVGs ÙˆØ§Ù„ØµÙÙ‚Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            displayTradingViewChart(candlestickData, contract, dataSource, orderBlocksData, executedTradesData, fvgsData);
            const latestCandle = candlestickData[candlestickData.length - 1];
            const currentPrice = (typeof data.current_price === 'number') ? data.current_price : latestCandle.close;
            const priceElement = document.getElementById('currentPrice');
            if (priceElement) {
                priceElement.style.transition = 'color 0.3s';
                priceElement.textContent = `$${currentPrice.toFixed(2)}`;
                priceElement.style.color = '#f59e0b';
                setTimeout(() => { priceElement.style.color = '#10b981'; }, 300);
            }
            const priceChange = document.getElementById('priceChange');
            if (priceChange) {
                let priceChangeHtml = '';
                if (lastPrice !== null) {
                    const change = currentPrice - lastPrice;
                    const changePercent = lastPrice === 0 ? 0 : ((change / lastPrice) * 100).toFixed(2);
                    const arrow = change > 0 ? 'â–²' : change < 0 ? 'â–¼' : 'â”€';
                    const color = change > 0 ? '#10b981' : change < 0 ? '#ef4444' : '#64748b';
                    priceChangeHtml = `<span style="color:${color};">${arrow} ${Math.abs(change).toFixed(2)} (${changePercent}%)</span>`;
                }
                priceChange.innerHTML = priceChangeHtml;
            }
            lastPrice = currentPrice;
            const contractElement = document.getElementById('contractName');
            if (contractElement) contractElement.textContent = contract;
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (lastUpdateElement) {
                const now = new Date();
                lastUpdateElement.textContent = `ØªØ­Ø¯ÙŠØ«: ${now.toLocaleTimeString('ar-SA')} (${dataSource})`;
            }
            const liveIndicator = document.getElementById('liveIndicator');
            if (liveIndicator) {
                liveIndicator.style.background = dataSource === 'LIVE' ? '#10b981' : '#f59e0b';
            }
        }
        */
        
        function handleChartPayload(payload) {
            if (!payload) return;
            console.log(`[CHART] ğŸ“¥ Socket.IO payload received:`, payload);
            console.log(`[CHART] ğŸ“¥ Payload keys:`, Object.keys(payload));
            console.log(`[CHART] ğŸ“¥ order_blocks in payload:`, payload.order_blocks);
            console.log(`[CHART] ğŸ“¥ fvgs in payload:`, payload.fvgs);
            console.log(`[CHART] ğŸ“¥ executed_trades in payload:`, payload.executed_trades);
            
            // Store the payload globally so separate events can merge with it
            window.lastChartPayload = payload;
            
            applyChartData(payload, payload.contract, payload.data_source);
        }

        function renderExecutedTrades(trades = []) {
            const card = document.getElementById('executedTradesCard');
            const container = document.getElementById('executedTrades');
            if (!card || !container) return;
            card.style.display = 'block';
            if (!Array.isArray(trades) || trades.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#475569; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…Ù†ÙØ°Ø© Ø¨Ø¹Ø¯</p>';
                return;
            }
            const rows = trades.slice(0, 25).map(trade => {
                const prob = typeof trade.probability === 'number'
                    ? `${(trade.probability * 100).toFixed(1)}%`
                    : 'N/A';
                const time = trade.timestamp ? new Date(trade.timestamp).toLocaleTimeString('ar-SA') : '--';
                const typeColor = (trade.type || '').toUpperCase() === 'BUY' ? '#10b981' : '#f87171';
                return `
                    <div class="executed-entry">
                        <div>
                            <strong style="color:${typeColor};">${trade.type || '--'}</strong>
                            @ ${trade.entry ?? '--'} | SL: ${trade.sl ?? '--'} | TP: ${trade.tp ?? '--'}
                        </div>
                        <div class="executed-meta">
                            â±ï¸ ${time} | ğŸ¯ ${trade.contract || '--'} | ğŸ“ˆ Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©: ${prob}
                        </div>
                        <div class="executed-meta">
                            ğŸ§  Ø§Ù„Ø³Ø¨Ø¨: ${trade.reason || '---'} | Ø§Ù„Ù…ØµØ¯Ø±: ${trade.source || 'UNKNOWN'} | Order: ${trade.order_id || '---'}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = rows;
        }

        async function refreshExecutedTrades() {
            try {
                const res = await fetch('/api/executed_trades');
                const data = await res.json();
                if (data.success) {
                    renderExecutedTrades(data.trades || []);
                }
            } catch (error) {
                console.error('[EXECUTED] Error:', error);
                addLog(`[ERROR] Executed trades: ${error.message}`);
            }
        }

        function renderSkippedTrades(trades = []) {
            const card = document.getElementById('skippedTradesCard');
            const container = document.getElementById('skippedTrades');
            if (!card || !container) return;
            card.style.display = 'block';
            if (!Array.isArray(trades) || trades.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#475569; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙ‚Ø§Øª Ù…ØªØ¬Ø§Ù‡Ù„Ø©</p>';
                return;
            }
            const rows = trades.slice(0, 25).map(trade => {
                const prob = typeof trade.probability === 'number'
                    ? `${(trade.probability * 100).toFixed(1)}%`
                    : 'N/A';
                const time = trade.timestamp ? new Date(trade.timestamp).toLocaleTimeString('ar-SA') : '--';
                const typeColor = (trade.type || '').toUpperCase() === 'BUY' ? '#10b981' : '#f87171';
                return `
                    <div class="executed-entry">
                        <div>
                            <strong style="color:${typeColor};">${trade.type || '--'}</strong>
                            @ ${trade.entry ?? '--'} | SL: ${trade.sl ?? '--'} | TP: ${trade.tp ?? '--'}
                        </div>
                        <div class="executed-meta">
                            â±ï¸ ${time} | ğŸ¯ ${trade.contract || '--'} | ğŸ“‰ Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©: ${prob}
                        </div>
                        <div class="executed-meta">
                            ğŸ§  Ø§Ù„Ø³Ø¨Ø¨: ${trade.reason || '---'} | Ø§Ù„Ù…ØµØ¯Ø±: ${trade.source || 'UNKNOWN'}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = rows;
        }

        async function refreshSkippedTrades() {
            try {
                const res = await fetch('/api/skipped_trades');
                const data = await res.json();
                if (data.success) {
                    renderSkippedTrades(data.trades || []);
                }
            } catch (error) {
                console.error('[SKIPPED] Error:', error);
                addLog(`[ERROR] Skipped trades: ${error.message}`);
            }
        }

        async function updateCSVInfo() {
            try {
                const res = await fetch('/api/today_signals_csv_info');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Content-Type
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await res.text();
                    console.error('[CSV] Expected JSON but got:', contentType, text.substring(0, 200));
                    throw new Error(`Expected JSON but got ${contentType}`);
                }
                
                const data = await res.json();
                const container = document.getElementById('csvInfo');
                const alertDiv = document.getElementById('csvAlert');
                
                if (!container) return;
                
                if (!data.success || !data.exists) {
                    container.innerHTML = `
                        <div style="text-align:center; color:#64748b; padding:20px;">
                            <p>ğŸ“ <strong>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù CSV Ù„Ù„ÙŠÙˆÙ…</strong></p>
                            <p style="font-size:0.9em; margin-top:10px;">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªÙ†ÙÙŠØ° Ø£ÙˆÙ„ Ø¥Ø´Ø§Ø±Ø©</p>
                            <p style="font-size:0.8em; color:#475569; margin-top:5px;">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ: <code style="font-size:0.85em;">${data.main_file_path || data.file_path || 'signals.csv'}</code></p>
                            ${data.message ? `<p style="font-size:0.8em; color:#ef4444; margin-top:5px;">âš ï¸ ${data.message}</p>` : ''}
                        </div>
                    `;
                    if (alertDiv) alertDiv.innerHTML = '';
                    return;
                }
                
                container.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                        <div style="background:#1e293b; padding:15px; border-radius:8px; border:1px solid #334155;">
                            <p style="color:#94a3b8; font-size:0.9em; margin-bottom:5px;">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</p>
                            <h3 style="color:#10b981; margin:0;">${new Date(data.date).toLocaleDateString('ar-SA')}</h3>
                        </div>
                        <div style="background:#1e293b; padding:15px; border-radius:8px; border:1px solid #334155;">
                            <p style="color:#94a3b8; font-size:0.9em; margin-bottom:5px;">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª</p>
                            <h3 style="color:#3b82f6; margin:0;">${data.total_signals}</h3>
                        </div>
                        <div style="background:#1e293b; padding:15px; border-radius:8px; border:1px solid #334155;">
                            <p style="color:#94a3b8; font-size:0.9em; margin-bottom:5px;">âœ… Ù…Ù†ÙØ°Ø©</p>
                            <h3 style="color:#10b981; margin:0;">${data.executed}</h3>
                        </div>
                        <div style="background:#1e293b; padding:15px; border-radius:8px; border:1px solid #334155;">
                            <p style="color:#94a3b8; font-size:0.9em; margin-bottom:5px;">â­ï¸ Ù…ØªØ¬Ø§Ù‡Ù„Ø©</p>
                            <h3 style="color:#f59e0b; margin:0;">${data.skipped}</h3>
                        </div>
                        <div style="background:#1e293b; padding:15px; border-radius:8px; border:1px solid #334155;">
                            <p style="color:#94a3b8; font-size:0.9em; margin-bottom:5px;">ğŸ’¾ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù</p>
                            <h3 style="color:#8b5cf6; margin:0;">${data.file_size_kb} KB</h3>
                        </div>
                    </div>
                    <div style="margin-top:15px; padding:10px; background:#1e293b; border-radius:8px; border:1px solid #334155;">
                        <p style="color:#64748b; font-size:0.85em; margin:0;">
                            ğŸ“ <strong>Ø§Ù„Ù…Ù„Ù:</strong> <code style="color:#94a3b8; font-size:0.9em;">${data.file_name}</code>
                        </p>
                        <p style="color:#64748b; font-size:0.85em; margin-top:5px; margin-bottom:0;">
                            ğŸ“‚ <strong>Ø§Ù„Ù…Ø³Ø§Ø±:</strong> <code style="color:#94a3b8; font-size:0.8em; word-break:break-all;">${data.file_path}</code>
                        </p>
                    </div>
                `;
                if (alertDiv) alertDiv.innerHTML = '';
            } catch (error) {
                console.error('[CSV] Error:', error);
                console.error('[CSV] Error stack:', error.stack);
                const container = document.getElementById('csvInfo');
                if (container) {
                    let errorMsg = error.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                    if (error.message && error.message.includes('Unexpected token')) {
                        errorMsg = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù… (ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„)';
                    }
                    container.innerHTML = `
                        <div style="color:#ef4444; text-align:center; padding:20px; background:#1e293b; border-radius:8px; border:1px solid #ef4444;">
                            <p>âŒ <strong>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª CSV</strong></p>
                            <p style="font-size:0.9em; margin-top:10px;">${errorMsg}</p>
                            <p style="font-size:0.8em; color:#94a3b8; margin-top:10px;">ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„ ÙˆØ£Ù† route /api/today_signals_csv_info Ù…ÙˆØ¬ÙˆØ¯</p>
                            <button onclick="updateCSVInfo()" style="margin-top:15px; padding:8px 15px; background:#ef4444; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
                        </div>
                    `;
                }
            }
        }

        function downloadTodayCSV() {
            try {
                const alertDiv = document.getElementById('csvAlert');
                if (alertDiv) {
                    alertDiv.innerHTML = '<div class="alert alert-info" style="padding:10px; margin:10px 0;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù...</div>';
                }
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„
                const link = document.createElement('a');
                link.href = '/api/today_signals_csv';
                link.download = `signals_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    if (alertDiv) {
                        alertDiv.innerHTML = '<div class="alert alert-success" style="padding:10px; margin:10px 0;">âœ… ØªÙ… Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­</div>';
                    }
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
                    updateCSVInfo();
                }, 500);
            } catch (error) {
                console.error('[CSV] Download error:', error);
                const alertDiv = document.getElementById('csvAlert');
                if (alertDiv) {
                    alertDiv.innerHTML = `<div class="alert alert-error" style="padding:10px; margin:10px 0; background:#ef4444; color:white;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${error.message}</div>`;
                }
            }
        }

        function renderSettingsUI(data) {
            if (!data) return;
            const minProbInput = document.getElementById('minProbInput');
            const maxTradesInput = document.getElementById('maxTradesInput');
            const maxLossInput = document.getElementById('maxLossInput');
            const thresholdMultInput = document.getElementById('thresholdMultInput');
            const minCandlesInput = document.getElementById('minCandlesInput');
            const minMomentumInput = document.getElementById('minMomentumInput');
            const debugSetupInput = document.getElementById('debugSetupInput');
            
            if (minProbInput && typeof data.min_ml_probability === 'number') {
                minProbInput.value = Math.round(data.min_ml_probability * 10) / 10; // Ø¹Ø±Ø¶ Ø¨Ø¯Ù‚Ø© ÙˆØ§Ø­Ø¯Ø©
            }
            if (maxTradesInput && typeof data.max_trades_per_day === 'number') {
                maxTradesInput.value = data.max_trades_per_day;
            }
            if (maxLossInput && typeof data.max_daily_loss === 'number') {
                maxLossInput.value = Math.round(data.max_daily_loss); // Ø¹Ø±Ø¶ Ø¨Ø¯ÙˆÙ† ÙƒØ³ÙˆØ±
            }
            if (thresholdMultInput && typeof data.setup_threshold_multiplier === 'number') {
                thresholdMultInput.value = Math.round(data.setup_threshold_multiplier * 100) / 100; // Ø¹Ø±Ø¶ Ø¨Ø¯Ù‚Ø© Ø§Ø«Ù†ØªÙŠÙ†
            }
            if (minCandlesInput && typeof data.min_candles_for_setup === 'number') {
                minCandlesInput.value = data.min_candles_for_setup;
            }
            if (minMomentumInput && typeof data.min_momentum_ticks === 'number') {
                minMomentumInput.value = data.min_momentum_ticks;
            }
            if (debugSetupInput && typeof data.debug_setup_detection === 'boolean') {
                debugSetupInput.checked = data.debug_setup_detection;
            }
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                if (data.success) {
                    renderSettingsUI(data.settings);
                }
            } catch (error) {
                console.error('[SETTINGS] Error:', error);
            }
        }

        window.saveSettings = async function saveSettings() {
            const minProb = parseFloat(document.getElementById('minProbInput').value);
            const maxTrades = parseInt(document.getElementById('maxTradesInput').value, 10);
            const maxLoss = parseFloat(document.getElementById('maxLossInput').value);
            const thresholdMult = parseFloat(document.getElementById('thresholdMultInput').value);
            const minCandles = parseInt(document.getElementById('minCandlesInput').value, 10);
            const minMomentum = parseInt(document.getElementById('minMomentumInput').value, 10);
            const debugSetup = document.getElementById('debugSetupInput').checked;
            const alertDiv = document.getElementById('settingsAlert');
            alertDiv.innerHTML = '<div class="alert alert-info">â³ Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...</div>';
            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        min_probability_percent: minProb,
                        max_trades_per_day: maxTrades,
                        max_daily_loss: maxLoss,
                        threshold_multiplier: thresholdMult,
                        min_candles_for_setup: minCandles,
                        min_momentum_ticks: minMomentum,
                        debug_setup_detection: debugSetup
                    })
                });
                const data = await res.json();
                if (data.success) {
                    renderSettingsUI(data.settings);
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù‚ÙŠÙ… (Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙØ¯Ø®Ù„Ø© Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ÙØ±Ø¬Ø¹Ø©)
                    const returnedProb = Math.round(data.settings.min_ml_probability * 10) / 10;
                    const returnedTrades = data.settings.max_trades_per_day;
                    const returnedLoss = Math.round(data.settings.max_daily_loss);
                    const returnedThreshold = Math.round(data.settings.setup_threshold_multiplier * 100) / 100;
                    const returnedCandles = data.settings.min_candles_for_setup;
                    const returnedMomentum = data.settings.min_momentum_ticks;
                    
                    let adjustedValues = [];
                    if (Math.abs(minProb - returnedProb) > 0.1) adjustedValues.push(`Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„ÙŠØ©: ${minProb}% â†’ ${returnedProb}%`);
                    if (maxTrades !== returnedTrades) adjustedValues.push(`Ø§Ù„ØµÙÙ‚Ø§Øª: ${maxTrades} â†’ ${returnedTrades}`);
                    if (Math.abs(maxLoss - returnedLoss) > 1) adjustedValues.push(`Ø§Ù„Ø®Ø³Ø§Ø±Ø©: $${maxLoss} â†’ $${returnedLoss}`);
                    if (Math.abs(thresholdMult - returnedThreshold) > 0.05) adjustedValues.push(`Ø§Ù„Ø¹ØªØ¨Ø©: ${thresholdMult}x â†’ ${returnedThreshold}x`);
                    if (minCandles !== returnedCandles) adjustedValues.push(`Ø§Ù„Ø´Ù…ÙˆØ¹: ${minCandles} â†’ ${returnedCandles}`);
                    if (minMomentum !== returnedMomentum) adjustedValues.push(`Momentum: ${minMomentum} â†’ ${returnedMomentum}`);
                    
                    if (adjustedValues.length > 0) {
                        alertDiv.innerHTML = `<div class="alert alert-warning">âš ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø¹Ø¶ Ø§Ù„Ù‚ÙŠÙ…:<br>${adjustedValues.join('<br>')}</div>`;
                    } else {
                        alertDiv.innerHTML = '<div class="alert alert-success">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</div>';
                    }
                } else {
                    alertDiv.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                }
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert alert-error">âŒ ${error.message}</div>`;
            }
        }
        
        function initRealtimeChannel(attempt = 0) {
            if (socket) return;
            
            if (typeof io !== 'function') {
                if (attempt > 20) {
                    console.error('[WS] Socket.IO client is not available after multiple retries');
                    addLog('[WS] âŒ Socket.IO client not available. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©.');
                    return;
                }
                setTimeout(() => initRealtimeChannel(attempt + 1), 500);
                return;
            }
            
            socket = io();
            socket.on('connect', () => {
                addLog('[WS] âœ… Connected to realtime channel');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙˆØ± Ø§Ù„Ø§ØªØµØ§Ù„
                updateStatus();
            });
            socket.on('disconnect', () => {
                addLog('[WS] âš ï¸ Disconnected from realtime channel');
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†Ù‚Ø·Ø§Ø¹
                renderStatus({
                    is_connected: false,
                    model_loaded: false,
                    is_trading: false
                });
            });
            socket.on('status', (data) => {
                console.log('[WS] Status received:', data);
                renderStatus(data);
            });
            socket.on('account', renderAccountInfo);
            socket.on('stats', renderStatsUI);
            socket.on('positions', data => renderPositions(data.positions || []));
            socket.on('orders', data => renderOrders(data.orders || []));
            socket.on('executed_trades', trades => renderExecutedTrades(trades));
            socket.on('skipped_trades', trades => renderSkippedTrades(trades));
            socket.on('settings', data => renderSettingsUI(data));
            socket.on('chart', handleChartPayload);
            
            // Handle separate events for order_blocks, fvgs, and executed_trades
            // Chart disabled - ignore chart events
            /*
            socket.on('chart_order_blocks', (data) => {
                console.log(`[CHART] ğŸ“¥ chart_order_blocks received:`, data);
                if (data && data.order_blocks !== undefined) {
                    // Merge with existing chart data
                    const currentPayload = window.lastChartPayload || {};
                    currentPayload.order_blocks = data.order_blocks;
                    window.lastChartPayload = currentPayload;
                    if (currentPayload.contract && currentPayload.data_source) {
                        applyChartData(currentPayload, currentPayload.contract, currentPayload.data_source);
                    }
                }
            });
            
            socket.on('chart_fvgs', (data) => {
                console.log(`[CHART] ğŸ“¥ chart_fvgs received:`, data);
                if (data && data.fvgs !== undefined) {
                    // Merge with existing chart data
                    const currentPayload = window.lastChartPayload || {};
                    currentPayload.fvgs = data.fvgs;
                    window.lastChartPayload = currentPayload;
                    if (currentPayload.contract && currentPayload.data_source) {
                        applyChartData(currentPayload, currentPayload.contract, currentPayload.data_source);
                    }
                }
            });
            
            socket.on('chart_executed_trades', (data) => {
                console.log(`[CHART] ğŸ“¥ chart_executed_trades received:`, data);
                if (data && data.executed_trades !== undefined) {
                    // Merge with existing chart data
                    const currentPayload = window.lastChartPayload || {};
                    currentPayload.executed_trades = data.executed_trades;
                    window.lastChartPayload = currentPayload;
                    if (currentPayload.contract && currentPayload.data_source) {
                        applyChartData(currentPayload, currentPayload.contract, currentPayload.data_source);
                    }
                }
            });
            */
            socket.on('log', entry => {
                if (entry && entry.message) {
                    addLog(`[${entry.level}] ${entry.message}`);
                }
            });
            socket.on('logs', entries => {
                if (Array.isArray(entries)) {
                    entries.forEach(entry => {
                        if (entry && entry.message) {
                            addLog(`[${entry.level}] ${entry.message}`);
                        }
                    });
                }
            });
        }
        
        // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ TradingView Chart
        function drawOrderBlocks(orderBlocks) {
            if (!tradingViewChart || !candlestickSeries) {
                console.log(`[CHART] âš ï¸ Chart or series not ready: chart=${!!tradingViewChart}, series=${!!candlestickSeries}`);
                return;
            }
            
            // Ø¥Ø²Ø§Ù„Ø© Order Blocks Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            obPriceLines.forEach(line => {
                try {
                    candlestickSeries.removePriceLine(line);
                } catch(e) {
                    // Ignore if already removed
                }
            });
            obPriceLines = [];
            
            if (!orderBlocks || orderBlocks.length === 0) {
                console.log(`[CHART] âš ï¸ No Order Blocks to draw: ${orderBlocks?.length || 0}`);
                return;
            }
            
            console.log(`[CHART] ğŸ¨ Drawing ${orderBlocks.length} Order Blocks...`);
            
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Price Lines Ù…Ù„ÙˆÙ†Ø© ÙˆÙˆØ§Ø¶Ø­Ø© Ù„Ø±Ø³Ù… Order Blocks
            let drawnCount = 0;
            orderBlocks.forEach((ob, index) => {
                try {
                    if (!ob || typeof ob.high !== 'number' || typeof ob.low !== 'number') {
                        console.warn(`[CHART] Invalid OB ${index + 1}:`, ob);
                        return;
                    }
                    
                    const isBullish = ob.type === 'Bullish';
                    const lineColor = isBullish ? '#10b981' : '#ef4444';  // Ø£Ø®Ø¶Ø± Ù„Ù„Ù€ BullishØŒ Ø£Ø­Ù…Ø± Ù„Ù„Ù€ Bearish
                    const lineWidth = 3;  // Ø®Ø· Ø£ÙƒØ«Ø± Ø³Ù…Ø§ÙƒØ©
                    
                    // Ø±Ø³Ù… Ø®Ø· Ø¹Ù„ÙˆÙŠ (High)
                    const highLine = candlestickSeries.createPriceLine({
                        price: ob.high,
                        color: lineColor,
                        lineWidth: lineWidth,
                        lineStyle: 0,  // 0=solid
                        axisLabelVisible: true,
                        title: `${isBullish ? 'ğŸŸ¢' : 'ğŸ”´'} OB-H`,
                    });
                    obPriceLines.push(highLine);
                    
                    // Ø±Ø³Ù… Ø®Ø· Ø³ÙÙ„ÙŠ (Low)
                    const lowLine = candlestickSeries.createPriceLine({
                        price: ob.low,
                        color: lineColor,
                        lineWidth: lineWidth,
                        lineStyle: 0,
                        axisLabelVisible: true,
                        title: `${isBullish ? 'ğŸŸ¢' : 'ğŸ”´'} OB-L`,
                    });
                    obPriceLines.push(lowLine);
                    
                    drawnCount++;
                    console.log(`[CHART] âœ… OB ${index + 1}: ${ob.type} @ $${ob.low.toFixed(2)}-$${ob.high.toFixed(2)}`);
                } catch(e) {
                    console.error(`[CHART] Error drawing OB ${index + 1}:`, e, ob);
                }
            });
            
            console.log(`[CHART] âœ… Added ${drawnCount}/${orderBlocks.length} Order Blocks (Price Lines)`);
        }
        
        function drawTradeMarkers(trades) {
            if (!tradingViewChart || !candlestickSeries || !trades || trades.length === 0) return;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø§Ø±ÙƒØ±Ø²
            tradeMarkers = [];
            
            trades.forEach(trade => {
                if (!trade.entry || !trade.timestamp) return;
                
                try {
                    const entryTime = Math.floor(new Date(trade.timestamp).getTime() / 1000);
                    const isBuy = (trade.type || '').toUpperCase() === 'BUY';
                    
                    // Entry marker
                    tradeMarkers.push({
                        time: entryTime,
                        position: isBuy ? 'belowBar' : 'aboveBar',
                        color: isBuy ? '#10b981' : '#ef4444',
                        shape: isBuy ? 'arrowUp' : 'arrowDown',
                        text: `${trade.type} @ ${trade.entry}`,
                        size: 2,
                    });
                    
                    // SL marker
                    if (trade.sl) {
                        tradeMarkers.push({
                            time: entryTime,
                            position: isBuy ? 'belowBar' : 'aboveBar',
                            color: '#ef4444',
                            shape: 'square',
                            text: `SL: ${trade.sl}`,
                            size: 1,
                        });
                    }
                    
                    // TP marker
                    if (trade.tp) {
                        tradeMarkers.push({
                            time: entryTime,
                            position: isBuy ? 'aboveBar' : 'belowBar',
                            color: '#10b981',
                            shape: 'circle',
                            text: `TP: ${trade.tp}`,
                            size: 1,
                        });
                    }
                } catch(e) {
                    console.warn('[CHART] Error adding trade marker:', e);
                }
            });
            
            if (tradeMarkers.length > 0) {
                candlestickSeries.setMarkers(tradeMarkers);
                console.log(`[CHART] âœ… Added ${tradeMarkers.length} trade markers`);
            }
        }
        
        function displayTradingViewChart(candlestickData, contractName, dataSource, orderBlocks = [], executedTrades = [], fvgs = []) {
            const chartContainer = document.getElementById('tradingview_chart');
            
            if (!chartContainer) {
                console.error('[CHART] Container not found');
                return;
            }
            
            // Check if Lightweight Charts is loaded
            if (typeof LightweightCharts === 'undefined' || typeof LightweightCharts.createChart !== 'function') {
                chartContainer.innerHTML = '<div style="padding:50px; text-align:center; color:#ef4444;">âŒ Ù…ÙƒØªØ¨Ø© Lightweight Charts ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©<br><small>Ø¬Ø±Ø¨ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©</small></div>';
                console.error('[CHART] LightweightCharts is undefined');
                return;
            }
            
            // Check if we have data
            if (!candlestickData || candlestickData.length === 0) {
                chartContainer.innerHTML = '<div style="padding:50px; text-align:center; color:#94a3b8;">âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶</div>';
                return;
            }
            
            // Clear container
            chartContainer.innerHTML = '';
            
            // Destroy existing chart if any
            if (lightweightChart) {
                try {
                    lightweightChart.remove();
                } catch(e) {
                    console.warn('[CHART] Error removing old chart:', e);
                }
                lightweightChart = null;
                candlestickSeries = null;
                orderBlockPriceLines = [];
                fvgPriceLines = [];
                tradeMarkers = [];
            }
            
            try {
                console.log('[CHART] Creating Lightweight Charts...');
                console.log(`[CHART] Data: ${candlestickData.length} candles, OBs=${orderBlocks?.length || 0}, FVGs=${fvgs?.length || 0}, Trades=${executedTrades?.length || 0}`);
                
                // Create chart
                lightweightChart = LightweightCharts.createChart(chartContainer, {
                    layout: {
                        background: { color: '#0f172a' },
                        textColor: '#e2e8f0',
                    },
                    grid: {
                        vertLines: { color: '#334155' },
                        horzLines: { color: '#334155' },
                    },
                    width: chartContainer.clientWidth,
                    height: 400,
                    timeScale: {
                        timeVisible: true,
                        secondsVisible: false,
                    },
                    rightPriceScale: {
                        borderColor: '#334155',
                    },
                });
                
                // Create candlestick series
                candlestickSeries = lightweightChart.addCandlestickSeries({
                    upColor: '#10b981',
                    downColor: '#ef4444',
                    borderVisible: true,
                    wickUpColor: '#10b981',
                    wickDownColor: '#ef4444',
                });
                
                // Convert and set data
                const chartData = candlestickData.map(candle => ({
                    time: candle.time,
                    open: candle.open,
                    high: candle.high,
                    low: candle.low,
                    close: candle.close,
                }));
                
                candlestickSeries.setData(chartData);
                
                // Draw Order Blocks
                if (orderBlocks && orderBlocks.length > 0) {
                    orderBlocks.forEach(ob => {
                        try {
                            const color = ob.type === 'Bullish' ? 'rgba(16, 185, 129, 0.3)' : 'rgba(239, 68, 68, 0.3)';
                            const lineColor = ob.type === 'Bullish' ? '#10b981' : '#ef4444';
                            
                            // High line
                            const highLine = candlestickSeries.createPriceLine({
                                price: ob.high,
                                color: lineColor,
                                lineWidth: 2,
                                lineStyle: LightweightCharts.LineStyle.Solid,
                                axisLabelVisible: true,
                                title: `OB ${ob.type} High`,
                            });
                            orderBlockPriceLines.push(highLine);
                            
                            // Low line
                            const lowLine = candlestickSeries.createPriceLine({
                                price: ob.low,
                                color: lineColor,
                                lineWidth: 2,
                                lineStyle: LightweightCharts.LineStyle.Solid,
                                axisLabelVisible: true,
                                title: `OB ${ob.type} Low`,
                            });
                            orderBlockPriceLines.push(lowLine);
                        } catch(e) {
                            console.warn('[CHART] Error drawing Order Block:', e);
                        }
                    });
                    console.log(`[CHART] âœ… Drew ${orderBlocks.length} Order Blocks`);
                }
                
                // Draw FVGs
                if (fvgs && fvgs.length > 0) {
                    fvgs.forEach(fvg => {
                        try {
                            const color = fvg.type === 'Bullish' ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                            const lineColor = fvg.type === 'Bullish' ? '#10b981' : '#ef4444';
                            
                            // Top line
                            const topLine = candlestickSeries.createPriceLine({
                                price: fvg.top,
                                color: lineColor,
                                lineWidth: 1,
                                lineStyle: LightweightCharts.LineStyle.Dashed,
                                axisLabelVisible: true,
                                title: `FVG ${fvg.type} Top`,
                            });
                            fvgPriceLines.push(topLine);
                            
                            // Bottom line
                            const bottomLine = candlestickSeries.createPriceLine({
                                price: fvg.bottom,
                                color: lineColor,
                                lineWidth: 1,
                                lineStyle: LightweightCharts.LineStyle.Dashed,
                                axisLabelVisible: true,
                                title: `FVG ${fvg.type} Bottom`,
                            });
                            fvgPriceLines.push(bottomLine);
                        } catch(e) {
                            console.warn('[CHART] Error drawing FVG:', e);
                        }
                    });
                    console.log(`[CHART] âœ… Drew ${fvgs.length} FVGs`);
                }
                
                // Draw Trade Markers
                if (executedTrades && executedTrades.length > 0) {
                    executedTrades.forEach(trade => {
                        try {
                            const position = trade.type === 'BUY' ? 'belowBar' : 'aboveBar';
                            const color = trade.result === 'WIN' ? '#10b981' : trade.result === 'LOSS' ? '#ef4444' : '#f59e0b';
                            const shape = trade.type === 'BUY' ? 'arrowUp' : 'arrowDown';
                            
                            tradeMarkers.push({
                                time: trade.entry_time || trade.time || candlestickData[candlestickData.length - 1].time,
                                position: position,
                                color: color,
                                shape: shape,
                                text: `${trade.type} @ ${trade.entry}`,
                            });
                        } catch(e) {
                            console.warn('[CHART] Error creating trade marker:', e);
                        }
                    });
                    
                    if (tradeMarkers.length > 0) {
                        candlestickSeries.setMarkers(tradeMarkers);
                        console.log(`[CHART] âœ… Added ${tradeMarkers.length} trade markers`);
                    }
                }
                
                // Fit content
                lightweightChart.timeScale().fitContent();
                
                // Update price display
                if (candlestickData.length > 0) {
                    const latestPrice = candlestickData[candlestickData.length - 1].close;
                    const priceElement = document.getElementById('currentPrice');
                    if (priceElement) {
                        priceElement.textContent = `$${latestPrice.toFixed(2)}`;
                    }
                    
                    const contractElement = document.getElementById('contractName');
                    if (contractElement) {
                        contractElement.textContent = contractName || '--';
                    }
                    
                    const lastUpdateElement = document.getElementById('lastUpdate');
                    if (lastUpdateElement) {
                        const now = new Date();
                        lastUpdateElement.textContent = `ØªØ­Ø¯ÙŠØ«: ${now.toLocaleTimeString('ar-SA')} (${dataSource})`;
                    }
                }
                
                // Handle resize
                const resizeObserver = new ResizeObserver(entries => {
                    if (lightweightChart && entries.length > 0) {
                        const { width, height } = entries[0].contentRect;
                        lightweightChart.applyOptions({ width, height });
                    }
                });
                resizeObserver.observe(chartContainer);
                
                console.log(`[CHART] âœ… Lightweight Chart created with ${candlestickData.length} candles`);
                
            } catch(error) {
                console.error('[CHART] âŒ Error creating Lightweight Chart:', error);
                chartContainer.innerHTML = `<div style="padding:50px; text-align:center; color:#ef4444;">âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ: ${error.message}<br><small>${error.stack}</small></div>`;
            }
        }

        window.updateChart = async function updateChart() {
            await loadChartData();
        }
        
        async function loadChartData() {
            try {
                console.log('[CHART] ğŸ“Š Loading chart data from API...');
                addLog('[CHART] ğŸ“Š Loading chart data...');
                
                const res = await fetch('/api/chart_data');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                
                const data = await res.json();
                console.log('[CHART] ğŸ“¥ Chart data response:', data);
                
                if (data.success && data.candles && data.candles.length > 0) {
                    applyChartData(data, data.contract, data.data_source);
                    addLog(`[CHART] âœ… Chart loaded: ${data.candles.length} candles`);
                } else {
                    console.warn('[CHART] âš ï¸ No chart data available:', data.message || 'Unknown error');
                    addLog(`[CHART] âš ï¸ ${data.message || 'No chart data available'}`);
                }
            } catch (error) {
                console.error('[CHART] âŒ Error loading chart data:', error);
                addLog(`[CHART] âŒ Error: ${error.message}`);
            }
        }

        function startChartUpdates() {
            // Ø§Ù„Ø´Ø§Ø±Øª Ù…Ø¹Ø·Ù„ Ù…Ø¤Ù‚ØªØ§Ù‹
            console.log('[CHART] Chart updates are temporarily disabled');
            addLog('[INFO] Chart is temporarily disabled');
            return;
            
            /* Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹Ø·Ù„
            // Show chart card
            document.getElementById('chartCard').style.display = 'block';
            
            // Initial load
            // updateChart(); // Chart disabled
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
                chartUpdateInterval = null;
            }
            addLog('[REALTIME] Chart streaming via WebSocket (HTTP fallback ready).');
            */
        }

        // ØªØ¹Ø±ÙŠÙ connect ÙÙŠ window Ù…Ø¨Ø§Ø´Ø±Ø©
        window.connect = async function connect() {
            const env = document.getElementById('env').value;
            const username = document.getElementById('username').value;
            const apiKey = document.getElementById('apiKey').value;
            const alert = document.getElementById('connAlert');

            if (!username || !apiKey) {
                alert.innerHTML = '<div class="alert alert-error">âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„</div>';
                return;
            }

            alert.innerHTML = '<div class="alert alert-info">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ...</div>';
            addLog(`[CONNECT] Connecting to ${env} with username: ${username}`);

            try {
                const res = await fetch('/api/connect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({environment: env, username, api_key: apiKey})
                });

                const data = await res.json();

                if (data.success) {
                    alert.innerHTML = '<div class="alert alert-success">âœ… Ø§ØªØµØ§Ù„ Ø­Ù‚ÙŠÙ‚ÙŠ Ù†Ø´Ø·!</div>';
                    document.getElementById('connectBtn').style.display = 'none';
                    document.getElementById('disconnectBtn').style.display = 'block';
                    addLog(`[CONNECT] âœ… Connected to ProjectX successfully`);
                    addLog(`[ACCOUNT] Balance: $${data.account_info.balance}`);
                    
                    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
                    await loadAccounts();
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù‚ÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                    await loadContracts();
                    
                    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø§Ø±Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„
                    setTimeout(() => {
                        loadChartData();
                    }, 2000);
                    
                    startAutoUpdate();
                } else {
                    alert.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                    addLog(`[ERROR] Connection failed: ${data.message}`);
                }
            } catch (error) {
                alert.innerHTML = `<div class="alert alert-error">âŒ ${error.message}</div>`;
                addLog(`[ERROR] ${error.message}`);
            }
        };

        async function loadAccounts() {
            try {
                const res = await fetch('/api/accounts');
                const data = await res.json();

                if (data.accounts && data.accounts.length > 0) {
                    const select = document.getElementById('accountSelect');
                    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ --</option>';
                    
                    data.accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = `${acc.name} - $${acc.balance.toLocaleString()} ${acc.canTrade ? 'âœ…' : 'âŒ'}`;
                        select.appendChild(option);
                    });
                    
                    document.getElementById('accountSelection').style.display = 'block';
                    addLog(`[ACCOUNTS] Found ${data.accounts.length} account(s)`);
                }
            } catch (error) {
                addLog(`[ERROR] Failed to load accounts: ${error.message}`);
            }
        }

        window.selectAccount = async function selectAccount() {
            const accountId = document.getElementById('accountSelect').value;
            
            if (!accountId) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨');
                return;
            }

            try {
                const res = await fetch('/api/select_account', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({account_id: parseInt(accountId)})
                });

                const data = await res.json();

                if (data.success) {
                    addLog(`[ACCOUNT] âœ… Selected: ${data.account.account_name}`);
                    addLog(`[ACCOUNT] Balance: $${data.account.balance.toLocaleString()}`);
                    document.getElementById('accountSelection').innerHTML = 
                        `<div class="alert alert-success">âœ… Ø­Ø³Ø§Ø¨ Ù†Ø´Ø·: ${data.account.account_name}</div>`;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„Ø©
                    document.getElementById('selectedAccount').textContent = data.account.account_name;
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ø®ØªÙŠØ§Ø± Contract ÙˆØ¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø­Ø§Ù„Ø©
                    document.getElementById('contractCard').style.display = 'block';
                    document.getElementById('apiStatusCard').style.display = 'block';
                    
                    // Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ù†Ø¨Ø¯Ø£ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§ÙƒØ² ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±
                    startPositionMonitoring();
                    
                    // Ø¨Ø¯Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
                    // startChartUpdates(); // Chart disabled
                } else {
                    alert(data.message);
                }
            } catch (error) {
                addLog(`[ERROR] ${error.message}`);
            }
        }

        async function loadContracts() {
            try {
                const res = await fetch('/api/contracts');
                const data = await res.json();
                
                if (data.success && data.contracts && data.contracts.length > 0) {
                    const select = document.getElementById('contractSelect');
                    select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù‚Ø¯ --</option>';
                    
                    data.contracts.forEach(contract => {
                        const option = document.createElement('option');
                        option.value = contract.id;
                        option.textContent = `${contract.name} - ${contract.description} ${contract.activeContract ? 'âœ…' : ''}`;
                        if (contract.activeContract) {
                            option.selected = true;
                            selectedContract = contract.id;
                        }
                        select.appendChild(option);
                    });
                    
                    // Auto-select active contract
                    if (data.active_contract) {
                        selectedContract = data.active_contract;
                        // Select in dropdown
                        const select = document.getElementById('contractSelect');
                        if (select) {
                            select.value = data.active_contract;
                        }
                        // Call API to select
                        try {
                            const res = await fetch('/api/select_contract', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({contract_id: data.active_contract})
                            });
                            const result = await res.json();
                            if (result.success) {
                                addLog(`[CONTRACT] âœ… Auto-selected: ${data.active_contract}`);
                                // updateChart(); // Chart disabled
                            }
                        } catch(e) {
                            console.error('[CONTRACT] Error selecting:', e);
                        }
                    }
                }
            } catch (error) {
                console.error('[CONTRACTS] Error:', error);
            }
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø±Ø§ÙƒØ² ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±
        let monitoringInterval = null;
        
        async function updateAccountInfo() {
            try {
                const res = await fetch('/api/account');
                if (res.ok) {
                    const data = await res.json();
                    renderAccountInfo(data);
                }
            } catch (error) {
                console.error('[ACCOUNT] Error updating balance:', error);
            }
        }
        
        function startPositionMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            updatePositions();
            updateOrders();
            updateAccountInfo();
            addLog('[REALTIME] Positions & orders streaming via WebSocket.');
        }

        async function updatePositions() {
            try {
                console.log('[POSITIONS] Fetching positions...');
                const res = await fetch('/api/positions');
                
                if (!res.ok) {
                    console.error(`[POSITIONS] HTTP Error ${res.status}`);
                    return;
                }
                
                const data = await res.json();
                console.log(`[POSITIONS] Response:`, data);

                renderPositions(data.positions || []);
            } catch (error) {
                console.error('[POSITIONS] âŒ Error:', error);
                addLog(`[ERROR] Positions: ${error.message}`);
            }
        }

        async function updateOrders() {
            try {
                console.log('[ORDERS] Fetching orders...');
                const res = await fetch('/api/orders');
                
                if (!res.ok) {
                    console.error(`[ORDERS] HTTP Error ${res.status}`);
                    return;
                }
                
                const data = await res.json();
                console.log(`[ORDERS] Response:`, data);

                renderOrders(data.orders || []);
            } catch (error) {
                console.error('[ORDERS] âŒ Error:', error);
                addLog(`[ERROR] Orders: ${error.message}`);
            }
        }

        window.closePosition = async function closePosition(contractId) {
            if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø±ÙƒØ²: ${contractId}?`)) return;
            
            try {
                const res = await fetch('/api/close_position', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({contract_id: contractId})
                });

                const data = await res.json();

                if (data.success) {
                    addLog(`[POSITION] âœ… Closed: ${contractId}`);
                    updatePositions();
                } else {
                    addLog(`[ERROR] ${data.message}`);
                }
            } catch (error) {
                addLog(`[ERROR] ${error.message}`);
            }
        }

        window.cancelOrder = async function cancelOrder(orderId) {
            // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© API endpoint Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø±
            addLog(`[INFO] Cancel order ${orderId} - Coming soon`);
        }

        window.selectContract = async function selectContract() {
            const contractId = document.getElementById('contractSelect').value;
            const alert = document.getElementById('contractAlert');
            
            try {
                const res = await fetch('/api/select_contract', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({contract_id: contractId})
                });

                const data = await res.json();

                if (data.success) {
                    selectedContract = contractId; // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±
                    alert.innerHTML = '<div class="alert alert-success">âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù‚Ø¯</div>';
                    addLog(`[CONTRACT] âœ… Selected: ${contractId}`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    // updateChart(); // Chart disabled
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹
                    document.getElementById('quickTradeCard').style.display = 'block';
                    document.getElementById('executedTradesCard').style.display = 'block';
                    document.getElementById('skippedTradesCard').style.display = 'block';
                } else {
                    alert.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                }
            } catch (error) {
                alert.innerHTML = `<div class="alert alert-error">âŒ ${error.message}</div>`;
            }
        }

        window.executeTrade = async function executeTrade() {
            const type = document.getElementById('tradeType').value;
            const entry = parseFloat(document.getElementById('tradeEntry').value);
            const sl = parseFloat(document.getElementById('tradeSL').value);
            const tp = parseFloat(document.getElementById('tradeTP').value);
            const strength = parseFloat(document.getElementById('tradeStrength').value);
            const alert = document.getElementById('tradeAlert');

            if (!entry || !sl || !tp) {
                alert.innerHTML = '<div class="alert alert-error">âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„</div>';
                return;
            }

            alert.innerHTML = '<div class="alert alert-info">â³ Ø¬Ø§Ø±ÙŠ ØªÙ‚ÙŠÙŠÙ… Setup Ø¨ÙˆØ§Ø³Ø·Ø© ML...</div>';
            addLog(`[TRADE] Evaluating ${type} setup: Entry=${entry}, SL=${sl}, TP=${tp}`);

            try {
                const res = await fetch('/api/place_trade', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        setup: {
                            type: type,
                            entry: entry,
                            sl: sl,
                            tp: tp,
                            strength: strength,
                            priority: 10
                        }
                    })
                });

                const data = await res.json();

                if (data.success) {
                    if (data.decision === 'TAKE') {
                        alert.innerHTML = `<div class="alert alert-success">âœ… ML: TAKE (${(data.probability * 100).toFixed(1)}%) | Order ID: ${data.order_id}</div>`;
                        addLog(`[TRADE] âœ… ML Decision: TAKE (${(data.probability * 100).toFixed(1)}%)`);
                        addLog(`[ORDER] Order placed: ID ${data.order_id}`);
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§ÙƒØ² ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±
                        setTimeout(() => {
                            updatePositions();
                            updateOrders();
                        }, 1000);
                    } else {
                        alert.innerHTML = `<div class="alert alert-warning">â­ï¸ ML: SKIP (${(data.probability * 100).toFixed(1)}%)</div>`;
                        addLog(`[TRADE] â­ï¸ ML Decision: SKIP (${(data.probability * 100).toFixed(1)}%)`);
                    }
                } else {
                    alert.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                    addLog(`[ERROR] ${data.message}`);
                }
            } catch (error) {
                alert.innerHTML = `<div class="alert alert-error">âŒ ${error.message}</div>`;
                addLog(`[ERROR] ${error.message}`);
            }
        }

        window.executeTradeDirect = async function executeTradeDirect() {
            const type = document.getElementById('tradeType').value;
            const entry = parseFloat(document.getElementById('tradeEntry').value);
            const sl = parseFloat(document.getElementById('tradeSL').value);
            const tp = parseFloat(document.getElementById('tradeTP').value);
            const alert = document.getElementById('tradeAlert');

            if (!entry || !sl || !tp) {
                alert.innerHTML = '<div class="alert alert-error">âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„</div>';
                return;
            }

            // ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°
            if (!confirm(`âš ï¸ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© ${type} Ù…Ø¨Ø§Ø´Ø±Ø©:\nEntry: ${entry}\nSL: ${sl}\nTP: ${tp}\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
                return;
            }

            alert.innerHTML = '<div class="alert alert-info">â³ Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©...</div>';
            addLog(`[TRADE] âš¡ Executing DIRECT ${type}: Entry=${entry}, SL=${sl}, TP=${tp}`);

            try {
                const res = await fetch('/api/place_trade_direct', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        setup: {
                            type: type,
                            entry: entry,
                            sl: sl,
                            tp: tp
                        }
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert.innerHTML = `<div class="alert alert-success">
                        âœ… ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø© Ø¨Ù†Ø¬Ø§Ø­!<br>
                        Order ID: ${data.order_id}<br>
                        ${data.sl_order ? `SL Order: ${data.sl_order}` : ''}<br>
                        ${data.tp_order ? `TP Order: ${data.tp_order}` : ''}
                    </div>`;
                    addLog(`[TRADE] âœ… DIRECT Trade executed: Order ID ${data.order_id}`);
                    addLog(`[ORDER] SL: ${data.sl_order || 'Failed'}, TP: ${data.tp_order || 'Failed'}`);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø§ÙƒØ² ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±
                    setTimeout(() => {
                        updatePositions();
                        updateOrders();
                        updateAccountInfo();
                    }, 1000);
                } else {
                    alert.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                    addLog(`[ERROR] Trade failed: ${data.message}`);
                }
            } catch (error) {
                alert.innerHTML = `<div class="alert alert-error">âŒ ${error.message}</div>`;
                addLog(`[ERROR] ${error.message}`);
            }
        }

        async function disconnect() {
            try {
                const res = await fetch('/api/disconnect', {method: 'POST'});
                const data = await res.json();

                document.getElementById('connectBtn').style.display = 'block';
                document.getElementById('disconnectBtn').style.display = 'none';
                document.getElementById('connAlert').innerHTML = '';
                document.getElementById('startBtn').disabled = true;

                addLog(`[DISCONNECT] Disconnected from ProjectX`);
                stopAutoUpdate();
            } catch (error) {
                addLog(`[ERROR] ${error.message}`);
            }
        }
        
        // ØªØ¹ÙŠÙŠÙ† disconnect ÙÙŠ window
        window.disconnect = disconnect;

        window.uploadModel = async function uploadModel() {
            const file = document.getElementById('modelFile').files[0];
            if (!file) return;

            const alert = document.getElementById('modelAlert');
            alert.innerHTML = '<div class="alert alert-info">â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„...</div>';
            addLog(`[MODEL] Uploading: ${file.name}`);

            const formData = new FormData();
            formData.append('model', file);

            try {
                const res = await fetch('/api/upload_model', {method: 'POST', body: formData});
                const data = await res.json();

                if (data.success) {
                    alert.innerHTML = '<div class="alert alert-success">âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„!</div>';
                    addLog(`[MODEL] âœ… ${data.message}`);
                    document.getElementById('startBtn').disabled = false;
                } else {
                    alert.innerHTML = `<div class="alert alert-error">âŒ ${data.message}</div>`;
                    addLog(`[ERROR] ${data.message}`);
                }
            } catch (error) {
                alert.innerHTML = `<div class="alert alert-error">âŒ ${error.message}</div>`;
                addLog(`[ERROR] ${error.message}`);
            }
        }

        window.startTrading = async function startTrading() {
            try {
                const res = await fetch('/api/start_trading', {method: 'POST'});
                const data = await res.json();

                if (data.success) {
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'block';
                    addLog(`[TRADING] âœ… Auto-trading started (REAL)`);
                }
            } catch (error) {
                addLog(`[ERROR] ${error.message}`);
            }
        }

        window.stopTrading = async function stopTrading() {
            try {
                const res = await fetch('/api/stop_trading', {method: 'POST'});
                document.getElementById('startBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
                addLog(`[TRADING] Stopped`);
            } catch (error) {
                addLog(`[ERROR] ${error.message}`);
            }
        }

        function startAutoUpdate() {
            if (updateInterval) return;
            updateStatus();
            updateAccount();
            updateStats();
            refreshExecutedTrades();
            refreshSkippedTrades();
            loadSettings();
            updateCSVInfo();  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª CSV
            updateInterval = setInterval(() => {
                updateStatus();
                updateAccount();
                updateStats();
                refreshExecutedTrades();
                refreshSkippedTrades();
                loadSettings();
                updateCSVInfo();  // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª CSV ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ©
            }, 15000);
            addLog('[REALTIME] HTTP fallback refresh every 15s (WebSocket live).');
        }

        function stopAutoUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        async function updateStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                if (data) {
                    console.log('[STATUS] Fetched status from API:', data);
                    renderStatus(data);
                } else {
                    console.warn('[STATUS] No data received from API');
                }
            } catch (error) {
                console.warn('[STATUS] Error fetching status:', error);
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø± Ø¨Ø­Ø§Ù„Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø·Ø£
                renderStatus({
                    is_connected: false,
                    model_loaded: false,
                    is_trading: false
                });
            }
        }

        async function updateAccount() {
            try {
                const res = await fetch('/api/account');
                const data = await res.json();
                if (!data.error) {
                    renderAccountInfo(data);
                }
            } catch (error) {
                console.warn('[ACCOUNT] Error:', error);
            }
        }

        async function updateStats() {
            try {
                const res = await fetch('/api/stats');
                const data = await res.json();
                renderStatsUI(data);
            } catch (error) {
                console.warn('[STATS] Error:', error);
            }
        }

        // Initialize
        addLog('[SYSTEM] Ready. Connect to ProjectX API to start.');
        
        // Ø¹Ø±Ø¶ Chart Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        document.addEventListener('DOMContentLoaded', function() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            updateStatus();
            updateAccount();
            updateStats();
            
            // Ø¨Ø¯Ø¡ WebSocket connection
            initRealtimeChannel();
            
            // Ø¹Ø±Ø¶ Chart ØªØ¬Ø±ÙŠØ¨ÙŠ
            setTimeout(() => {
                if (typeof LightweightCharts !== 'undefined') {
                    console.log('[CHART] Initializing with demo data...');
                    const demoData = generateDemoData(6580, 100);
                    displayTradingViewChart(demoData, 'CON.F.US.EP.U25', 'DEMO');
                    addLog('[CHART] ğŸ“Š Demo chart loaded (connect to see real data)');
                } else {
                    console.error('[CHART] LightweightCharts not available');
                }
            }, 1000);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            refreshExecutedTrades();
            refreshSkippedTrades();
            loadSettings();
            loadSettings();
        });
    </script>
</body>
</html>

